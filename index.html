<!DOCTYPE html>
<html>
<head>
    <title>CS 416 - Data Visualization Final Project: FAANG + SPX</title>
    <meta charset="utf-8">
    <style>
        body {
          justify-content: center;
          font-family: sans-serif;
        }
        .listening-rect {
            fill: transparent;
        }

        .dotted {
          stroke: #5c5c5c;
          stroke-dasharray: 1 1;
          fill: none;
        }

        .tooltip {
          opacity: 0;
          position: absolute;
          top: -14px;
          left: 0;
          padding: 0.6em 1em;
          background: #fff;
          text-align: center;
          line-height: 1.4em;
          font-size: 0.6em;
          border: 1px solid #ddd;
          z-index: 10;
          transition: all 0.1s ease-out;
          pointer-events: none;
        }

        .tooltip-date {
          margin-bottom: 0.2em;
          font-weight: 600;
          font-size: 1.1em;
          line-height: 1.4em;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
</head>
<body>
    <div id="main_chart" class="wrapper"></div>
    
    <script>

    var margin = {top: 100, right: 100, bottom: 100, left: 100},
        width = window.innerWidth * 0.90 - margin.left - margin.right,
        height = window.innerHeight * 0.90 - margin.top - margin.bottom;

    var svg = d3.select("#main_chart")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("https://raw.githubusercontent.com/arigemini/cs416_final_project/main/SPX_FAANG.csv",

      function(d){
        return {
            date : d3.timeParse("%Y-%m-%d")(d.Date),
            spx : +d.SPX,
            meta: +d.META,
            amzn: +d.AMZN,
            aapl: +d.AAPL,
            nflx: +d.NFLX,
            goog: +d.GOOG,
        }
      },

      function(data) {

        const xScale = d3.scaleTime()
          .domain(d3.extent(data, function(d) { return d.date; }))
          .range([ 0, width ]);
        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(xScale));

        var yScale = d3.scaleLinear()
          .domain([0, 6000])
          .range([ height, 0 ]);
        svg.append("g")
          .call(d3.axisLeft(yScale));

        var y2Scale = d3.scaleLinear()
          .domain([0, 1000])
          .range([ height, 0 ]);
        svg.append("g")
          .attr("transform", "translate(" + width + ",0)")
          .call(d3.axisRight(y2Scale));

                svg.append("text")
            .attr("text-anchor", "end")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom / 2)
            .text("Date");

        svg.append("text")
            .attr("text-anchor", "end")
            .attr("y", -margin.left / 2)
            .attr("x", (-height + margin.top) / 2)
            .attr("transform", "rotate(-90)")
            .text("S&P 500 Index");

        svg.append("text")
            .attr("text-anchor", "end")
            .attr("y", width + margin.right / 2)
            .attr("x", (-height + margin.top) / 2)
            .attr("transform", "rotate(-90)")
            .text("FAANG Share Price");
          
        tickers = ["spx", "meta", "amzn", "aapl", "nflx", "goog"];
          
        var color = d3.scaleOrdinal()
          .domain(tickers)
          .range(["gray", "blue", "orange", "pink", "red", "green"]);

        var legendItemWidth = 100;
        var legend = svg.selectAll(".legend")
          .data(tickers)
          .enter()
          .append("g")
          .attr("transform", function(d,i) { return "translate(" + ((i * legendItemWidth) + (width - tickers.length * legendItemWidth) / 2) + "," + (-margin.top / 4) + ")"; })
	      .attr("class","legend");
	
        var rects = legend.append('rect')
        	.attr("width",legendItemWidth / 2)
        	.attr("height",2)
        	.attr("fill", function(d) { return color(d); });
        	
        var text = legend.append('text')
        	.attr("x", 0)
        	.attr("y",15)
        	.text(function(d) { return d.toUpperCase(); });
          
        svg.append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", color("spx"))
          .attr("stroke-width", 1.5)
          .attr("d", d3.line()
            .x(function(d) { return xScale(d.date) })
            .y(function(d) { return yScale(d.spx) })
          );

        ["meta", "amzn", "aapl", "nflx", "goog"].forEach((ticker) => {
            svg.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", color(ticker))
            .attr("stroke-width", 1.5)
            .attr("d", d3.line()
                .x(function(d) { return xScale(d.date); })
                .y(function(d) { return y2Scale(d[ticker]); })
            );
        })

        svg.append("g")
            .append("text")
            .attr("class", "title")
            .attr("x", width / 2)
            .attr("y", -margin.top / 2)
            .attr("text-anchor", "middle")
            .text("Comparison of S&P 500 and FAANG share prices")
            .style("font-size", "30px")
            .style("text-decoration", "underline");

        const bounds = svg
            .append("g");
        
        const listeningRect = bounds
            .append("rect")
            .attr("class", "listening-rect")
            .attr("width", width)
            .attr("height", height)
            .on("mousemove", onMouseMove)
            .on("mouseleave", onMouseLeave);

        const xAxisLine = bounds
            .append("g")
            .append("rect")
            .attr("class", "dotted")
            .attr("stroke-width", "1px")
            .attr("height", height);

        const annotations = [
          {
            note: {
              label: "Covid",
              title: "2020-03-23",
              align: "middle",
                
            },
            connector: {
                end: "arrow",
            },
            x: xScale(d3.timeParse("%Y-%m-%d")('2020-03-23')),
            y: height,
            dy: 30,
            dx: 0
          },
          {
            note: {
              label: "S&P 500 Peak",
              title: "2022-01-04",
              align: "middle",
                
            },
            connector: {
                end: "arrow",
            },
            x: xScale(d3.timeParse("%Y-%m-%d")('2022-01-04')),
            y: height,
            dy: 30,
            dx: 0
          }
        ];
        
        const makeAnnotations = d3.annotation()
            .annotations(annotations);
        svg.append("g")
            .call(makeAnnotations);
          
        const tooltip = d3.select("#main_chart")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "1px")
            .style("border-radius", "5px")
            .style("padding", "2px");
            
        function onMouseMove() {
            const mousePosition = d3.mouse(this);
            const hoveredDate = xScale.invert(mousePosition[0]);
            const getDistanceFromHoveredDate = (d) =>
              Math.abs(d.date - hoveredDate);
            const closestIndex = d3.scan(
              data,
              (a, b) => getDistanceFromHoveredDate(a) - getDistanceFromHoveredDate(b)
            );
            const d = data[closestIndex];
            const formatDate = d3.timeFormat("%Y-%m-%d");
            tooltip.select("#date").text(formatDate(d.date));

            function paddedHtmlPx(v) {
                return v.toFixed(2).padStart(8, " ").replace(" ", "&nbsp;");
            }
            
            tooltip.html(
                formatDate(d.date) + "<br/>" + 
                `<span><span style="color: ${color("spx")}; text-align: left">SPX&nbsp;</span>: <span style="text-align: right">${paddedHtmlPx(d.spx)}</span></span> <br/>` +
                `<span><span style="color: ${color("meta")}; text-align: left">META</span>: <span style="text-align: right">${paddedHtmlPx(d.meta)}</span></span> <br/>` +
                `<span><span style="color: ${color("amzn")}; text-align: left">AMZN</span>: <span style="text-align: right">${paddedHtmlPx(d.amzn)}</span></span> <br/>` +
                `<span><span style="color: ${color("aapl")}; text-align: left">AAPL</span>: <span style="text-align: right">${paddedHtmlPx(d.aapl)}</span></span> <br/>` +
                `<span><span style="color: ${color("nflx")}; text-align: left">NFLX</span>: <span style="text-align: right">${paddedHtmlPx(d.nflx)}</span></span> <br/>` +
                `<span><span style="color: ${color("goog")}; text-align: left">GOOG</span>: <span style="text-align: right">${paddedHtmlPx(d.goog)}</span></span> <br/>`
            );
            tooltip.style("left", (mousePosition[0] + margin.left + 12) + "px")
                .style("top", margin.top + "px")
                .style("opacity", 1);
            
            xAxisLine.attr("width", ".5px")
                .attr("x", xScale(d.date));

        }

        function onMouseLeave() {
            xAxisLine.attr("width", 0);
            tooltip.style("opacity", 0);
        }
          
      }
    )

    </script>

</body>
</html>
